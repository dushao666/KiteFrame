# DBContext 重构和 Mapster 配置总结

## 重构概述

本次重构主要完成了两个目标：
1. **优化 DBContext**：移除了逻辑删除的重写方法，让 DBContext 更加优雅和职责单一
2. **替换对象映射工具**：将 AutoMapper 替换为 Mapster，提升性能和简化配置

## 修改详情

### 1. DBContext 优化

#### 修改前
```csharp
public class DbSet<T> : SimpleClient<T> where T : class, IDeleted, new()
{
    /// <summary>
    /// 逻辑删除
    /// </summary>
    public override bool Delete(T deleteObj)
    {
        deleteObj.IsDeleted = true;
        return Context.Updateable(deleteObj).ExecuteCommand() > 0;
    }
    
    // ... 其他逻辑删除方法
}
```

#### 修改后
```csharp
/// <summary>
/// 数据集合
/// </summary>
/// <typeparam name="T">实体类型</typeparam>
public class DbSet<T> : SimpleClient<T> where T : class, IDeleted, new()
{
    // 移除了逻辑删除的重写方法，因为已经在ServiceCollectionExtensions中通过AOP配置了逻辑删除
    // 这样让DBContext更加优雅，职责更加单一
}
```

#### 优势
- **职责单一**：DBContext 只负责数据访问，不处理业务逻辑
- **更加优雅**：代码更简洁，易于维护
- **AOP 统一处理**：逻辑删除通过 AOP 在 `ServiceCollectionExtensions.cs` 中统一配置

### 2. 对象映射工具替换

#### 包引用修改

**Application.csproj**
```xml
<!-- 修改前 -->
<PackageReference Include="AutoMapper" Version="12.0.1" />
<PackageReference Include="AutoMapper.Extensions.Microsoft.DependencyInjection" Version="12.0.1" />

<!-- 修改后 -->
<PackageReference Include="Mapster" Version="7.4.0" />
```

**Shared.csproj**
```xml
<!-- 修改前 -->
<PackageReference Include="AutoMapper" Version="12.0.1" />

<!-- 修改后 -->
<PackageReference Include="Mapster" Version="7.4.0" />
```

#### 全局导入修改

**_Imports.cs**
```csharp
// 修改前
global using AutoMapper;

// 修改后
global using Mapster;
```

#### 配置文件创建

创建了 `Application/DependencyInjection/MapsterConfiguration.cs`：
```csharp
public class MapsterConfiguration : IRegister
{
    public void Register(TypeAdapterConfig config)
    {
        // 配置User实体到UserDto的映射
        config.ForType<User, UserDto>()
            .Map(dest => dest.Id, src => src.Id)
            .Map(dest => dest.UserName, src => src.UserName)
            // ... 其他映射配置
            .Ignore(dest => dest.UpdateTime); // 忽略敏感字段
        
        // 全局配置
        config.Default.PreserveReference(true);
        config.Default.NameMatchingStrategy(NameMatchingStrategy.Flexible);
    }
}
```

#### 服务注册

在 `ProgramExtensions.cs` 中添加：
```csharp
// 配置 Mapster 对象映射
builder.Services.AddMapsterConfiguration();

private static IServiceCollection AddMapsterConfiguration(this IServiceCollection services)
{
    // 扫描并注册 Mapster 配置
    Mapster.TypeAdapterConfig.GlobalSettings.Scan(typeof(Application.DependencyInjection.MapsterConfiguration).Assembly);
    return services;
}
```

### 3. 代码使用示例

#### UserQueries 中的使用

**修改前**
```csharp
.Select(x => new UserDto
{
    Id = x.Id,
    UserName = x.UserName,
    Email = x.Email,
    // ... 手动映射所有字段
})
```

**修改后**
```csharp
var users = await query.ToListAsync();
// 使用Mapster进行对象映射
var items = users.Adapt<List<UserDto>>();
```

#### CreateUserCommandHandler 中的使用

**修改前**
```csharp
var user = new Domain.Entities.User
{
    UserName = request.UserName,
    Password = request.Password,
    Email = request.Email,
    // ... 手动映射所有字段
};
```

**修改后**
```csharp
// 使用Mapster进行对象映射
var user = request.Adapt<Domain.Entities.User>();
```

### 4. 文档更新

- 更新了 `README.md` 中的技术栈说明
- 创建了 `docs/Mapster使用指南.md` 详细使用文档
- 创建了本重构总结文档

## 性能提升

### Mapster vs AutoMapper
- **编译时优化**：Mapster 支持编译时生成映射代码
- **更少的反射**：减少运行时反射调用
- **更简洁的API**：`obj.Adapt<T>()` 比 `_mapper.Map<T>(obj)` 更简洁
- **更好的性能**：基准测试显示 Mapster 比 AutoMapper 快 2-3 倍

## 注意事项

1. **逻辑删除**：现在完全依赖 AOP 配置，确保 `ServiceCollectionExtensions.cs` 中的配置正确
2. **映射配置**：新的映射规则需要在 `MapsterConfiguration.cs` 中配置
3. **敏感字段**：记得在映射配置中忽略密码等敏感字段
4. **测试**：建议对修改的代码进行充分测试

## 构建状态

✅ 项目构建成功，所有编译错误已修复
⚠️ 存在一些 SqlSugar 版本兼容性警告，但不影响功能

## 后续建议

1. 编写单元测试验证映射配置的正确性
2. 考虑升级 SqlSugar 到支持 .NET 9 的版本
3. 根据实际需要添加更多的映射配置
4. 监控性能改进效果
